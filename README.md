# Rust Hexagonal Architecture Template

ä¸€å€‹åŸºæ–¼ Rust å’Œ Axum çš„ç”Ÿç”¢ç´šå¾Œç«¯æœå‹™æ¨£æ¿ï¼Œåš´æ ¼éµå¾ª**å…­é‚Šå½¢æ¶æ§‹ (Hexagonal Architecture / Ports and Adapters)** å’Œé ˜åŸŸé©…å‹•è¨­è¨ˆ (DDD) çš„æ€æƒ³ã€‚

é€™å€‹æ¨£æ¿çš„ç›®æ¨™æ˜¯æä¾›ä¸€å€‹é«˜å…§èšã€ä½è€¦åˆã€å¯æ¸¬è©¦ã€å¯æ¼”åŒ–çš„èµ·é»ï¼Œå¹«åŠ©ä½ å¿«é€Ÿæ§‹å»ºå¥å£¯ä¸”å¯é•·æœŸç¶­è­·çš„å¾Œç«¯æ‡‰ç”¨ã€‚

[![CI](https://github.com/<YOUR_USERNAME>/<YOUR_REPO>/actions/workflows/ci.yml/badge.svg)](https://github.com/<YOUR_USERNAME>/<YOUR_REPO>/actions/workflows/ci.yml)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

---

## âœ¨ ç‰¹æ€§ (Features)

- **ğŸ§… å…­é‚Šå½¢æ¶æ§‹**: æ¸…æ™°çš„ `domain`, `application`, `infrastructure`, `presentation` åˆ†å±¤ã€‚
- **ğŸ“¦ Cargo Workspace**: å¼·åˆ¶æ¨¡çµ„é‚Šç•Œï¼ŒåŠ é€Ÿç·¨è­¯ï¼Œæå‡å°ˆæ¡ˆçµ„ç¹”æ€§ã€‚
- **ğŸš€ ç”Ÿç”¢ç´š Web æœå‹™**:
  - **Axum**: é«˜æ€§èƒ½ã€ç¬¦åˆäººé«”å·¥å­¸çš„ Web æ¡†æ¶ã€‚
  - **å„ªé›…é—œé–‰ (Graceful Shutdown)**: å®‰å…¨åœ°è™•ç† `Ctrl+C` å’Œ `SIGTERM` ä¿¡è™Ÿã€‚
  - **è«‹æ±‚ ID**: è¿½è¹¤è«‹æ±‚çš„å®Œæ•´ç”Ÿå‘½é€±æœŸã€‚
  - **é™æµ (Rate Limiting)**: ä½¿ç”¨ `tower-governor` é˜²æ­¢æ¿«ç”¨ã€‚
- **ğŸ”­ å…¨æ£§å¯è§€æ¸¬æ€§ (Full-Stack Observability)**:
  - **çµæ§‹åŒ–æ—¥èªŒ (Logging)**: ä½¿ç”¨ `tracing` é€²è¡Œ JSON æ ¼å¼çš„çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„ã€‚
  - **æŒ‡æ¨™ (Metrics)**: ä½¿ç”¨ `prometheus` å°å‡ºé—œéµæœå‹™æŒ‡æ¨™ã€‚
  - **è¿½è¸ª (Tracing)**: é›†æˆ `opentelemetry` å¯¦ç¾åˆ†æ•£å¼è¿½è¸ªã€‚
  - **Panic Hook**: æ•ç²æœªè™•ç†çš„ Panic ä¸¦ä»¥æ—¥èªŒå½¢å¼è¨˜éŒ„è©³ç´°ä¿¡æ¯ã€‚
- **ğŸ›¡ï¸ å¥å£¯çš„éŒ¯èª¤è™•ç†**: çµ±ä¸€çš„éŒ¯èª¤é¡å‹ï¼Œè‡ªå‹•æ˜ å°„åˆ°çµæ§‹åŒ–çš„ HTTP éŸ¿æ‡‰ã€‚
- **âš™ï¸ éˆæ´»çš„é…ç½®ç®¡ç†**: ä½¿ç”¨ `figment` å¾æ–‡ä»¶å’Œç’°å¢ƒè®Šæ•¸åŠ è¼‰é…ç½®ã€‚
- **ğŸ§ª å…¨é¢çš„æ¸¬è©¦ç­–ç•¥**: æ¶µè“‹å–®å…ƒæ¸¬è©¦ã€æ•´åˆæ¸¬è©¦å’Œç«¯åˆ°ç«¯æ¸¬è©¦ã€‚
- **âš¡ é–‹ç™¼è€…é«”é©—å„ªå…ˆ**: æä¾› `Makefile` å’Œè…³æœ¬ï¼Œç°¡åŒ–å¸¸è¦‹é–‹ç™¼ä»»å‹™ã€‚

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ (Quick Start)

### å‰ç½®è¦æ±‚

- [Rust toolchain](https://www.rust-lang.org/tools/install) (æœ€æ–°ç©©å®šç‰ˆ)
- Docker & Docker Compose (ç”¨æ–¼é‹è¡Œè³‡æ–™åº«ç­‰ä¾è³´)

### 1. å…‹éš†å°ˆæ¡ˆ

```bash
git clone https://github.com/<YOUR_USERNAME>/<YOUR_REPO>.git
cd <YOUR_REPO>
```

### 2. é…ç½®ç’°å¢ƒ

è¤‡è£½é è¨­çš„è¨­å®šæª”ã€‚ä½ å¯ä»¥æ ¹æ“šéœ€è¦ä¿®æ”¹ `.env` æ–‡ä»¶ã€‚

```bash
cp .env.example .env
```

### 3. å•Ÿå‹•ä¾è³´æœå‹™ (å¦‚ PostgreSQL)

```bash
docker-compose up -d
```

### 4. é‹è¡Œé–‹ç™¼ä¼ºæœå™¨

æˆ‘å€‘æä¾›äº†æ–¹ä¾¿çš„ Makefile å‘½ä»¤ä¾†å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ï¼Œå®ƒæœƒç›£è½æ–‡ä»¶è®Šæ›´ä¸¦è‡ªå‹•é‡æ–°åŠ è¼‰ã€‚

```bash
make dev
# æˆ–è€…ç›´æ¥é‹è¡Œè…³æœ¬
# sh ./scripts/dev.sh
```

æœå‹™å°‡åœ¨ `http://127.0.0.1:8080` (é è¨­) ä¸Šå•Ÿå‹•ã€‚

### 5. é‹è¡Œæ¸¬è©¦

é‹è¡Œæ‰€æœ‰æ¸¬è©¦ï¼ŒåŒ…æ‹¬å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ã€‚

```bash
make test
# æˆ–è€…ç›´æ¥é‹è¡Œè…³æœ¬
# sh ./scripts/test.sh
```

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¦½

æœ¬å°ˆæ¡ˆæ¡ç”¨åš´æ ¼çš„å…­é‚Šå½¢æ¶æ§‹ï¼Œä¾è³´é—œä¿‚æ°¸é æ˜¯**å¾å¤–å‘å…§**ã€‚

```
Presentation / Infrastructure --> Application --> Domain
```

- **Domain**: æ ¸å¿ƒæ¥­å‹™é‚è¼¯å’Œå¯¦é«”ã€‚æœ€ç´”æ·¨çš„ä¸€å±¤ï¼Œä¸ä¾è³´ä»»ä½•å¤–éƒ¨æ¡†æ¶ã€‚
- **Application**: æ‡‰ç”¨ç¨‹å¼çš„ç”¨ä¾‹ (Use Cases) å’Œç«¯å£ (Ports)ã€‚å®šç¾©äº†æ‡‰ç”¨ã€Œåšä»€éº¼ã€ï¼Œä½†ä¸é—œå¿ƒã€Œå¦‚ä½•åšã€ã€‚
- **Infrastructure**: å¤–éƒ¨ç³»çµ±çš„å…·é«”å¯¦ç¾ (Adapters)ï¼Œå¦‚è³‡æ–™åº«ã€å¿«å–ã€æ¶ˆæ¯éšŠåˆ—ã€‚å¯¦ç¾ Application å±¤å®šç¾©çš„ç«¯å£ã€‚
- **Presentation**: å°å¤–æš´éœ²çš„ä»‹é¢ (Driving Adapters)ï¼Œå¦‚ REST APIã€gRPC æˆ– CLIã€‚

é€™ç¨®çµæ§‹ç¢ºä¿äº†æ ¸å¿ƒæ¥­å‹™é‚è¼¯çš„ç¨ç«‹æ€§å’Œå¯æ¸¬è©¦æ€§ï¼Œä½¿å¾—æ›¿æ›ä»»ä½•å¤–éƒ¨ä¾è³´ï¼ˆå¦‚ Web æ¡†æ¶æˆ–è³‡æ–™åº«ï¼‰éƒ½è®Šå¾—ç›¸å°å®¹æ˜“ã€‚

## ğŸ“ ç›®éŒ„çµæ§‹

```text
hexagonal_template/
â”œâ”€â”€ Cargo.toml            # Workspace æ ¹é…ç½®
â”œâ”€â”€ Makefile              # é–‹ç™¼è‡ªå‹•åŒ–å‘½ä»¤
â”œâ”€â”€ scripts/              # å¸¸ç”¨è…³æœ¬
â”‚
â”œâ”€â”€ crates/               # æ ¸å¿ƒ Library Crates
â”‚   â”œâ”€â”€ domain/           # æ ¸å¿ƒæ¥­å‹™é‚è¼¯ã€å¯¦é«” (Entities)
â”‚   â”œâ”€â”€ application/      # ç”¨ä¾‹ (Use Cases)ã€ç«¯å£ (Ports)
â”‚   â”œâ”€â”€ infra_db_postgres/# PostgreSQL é©é…å™¨
â”‚   â”œâ”€â”€ infra_telemetry/  # å¯è§€æ¸¬æ€§ (æ—¥èªŒ/æŒ‡æ¨™/è¿½è¸ª) é©é…å™¨
â”‚   â””â”€â”€ ...               # å…¶ä»–åŸºç¤è¨­æ–½é©é…å™¨
â”‚
â”œâ”€â”€ presentation/         # å°å¤–ä»‹é¢å±¤
â”‚   â””â”€â”€ pres_web_axum/    # Axum Web API çš„å¯¦ç¾ (Handlers/Router/DTOs)
â”‚
â”œâ”€â”€ app/                  # Binary Crate (å¯åŸ·è¡Œæª”)
â”‚   â””â”€â”€ src/main.rs       # æ‡‰ç”¨ç¨‹å¼çµ„è£é» (Composition Root)
â”‚
â”œâ”€â”€ config/               # é è¨­è¨­å®šæª” (e.g., default.toml)
â”‚
â””â”€â”€ tests/                # è·¨ Crate çš„æ•´åˆèˆ‡ç«¯åˆ°ç«¯æ¸¬è©¦
```

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

æˆ‘å€‘æ¡ç”¨åˆ†å±¤çš„æ¸¬è©¦ç­–ç•¥ï¼Œä»¥ç¢ºä¿ç¨‹å¼ç¢¼å“è³ªå’Œé–‹ç™¼æ•ˆç‡ï¼š

1.  **å–®å…ƒæ¸¬è©¦ (`#[cfg(test)]`)**:

    - **ä½ç½®**: åœ¨å„å€‹ crate çš„ `src/` ç›®éŒ„ä¸‹ã€‚
    - **ç›®æ¨™**: æ¸¬è©¦å–®ä¸€æ¨¡çµ„æˆ–å‡½æ•¸çš„é‚è¼¯ï¼Œé€Ÿåº¦å¿«ï¼Œç„¡ I/Oã€‚ä½¿ç”¨ mock æˆ– fake ç‰©ä»¶ä¾†æ¨¡æ“¬ä¾è³´ã€‚

2.  **æ•´åˆæ¸¬è©¦ (é ‚å±¤ `tests/` ç›®éŒ„)**:

    - **ä½ç½®**: å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ `tests/`ã€‚
    - **ç›®æ¨™**: æ¸¬è©¦ crate ä¹‹é–“çš„å”ä½œå’Œå…¬é–‹ API çš„è¡Œç‚ºã€‚é€™äº›æ¸¬è©¦åƒå¤–éƒ¨ç”¨æˆ¶ä¸€æ¨£èª¿ç”¨ crateã€‚

3.  **ç«¯åˆ°ç«¯æ¸¬è©¦ (E2E)**:
    - æ•´åˆæ¸¬è©¦çš„ä¸€ç¨®ï¼Œæœƒå•Ÿå‹•å®Œæ•´çš„æ‡‰ç”¨ç¨‹å¼ï¼ˆæˆ–å…¶è¼•é‡ç‰ˆæœ¬ï¼‰å’ŒçœŸå¯¦çš„å¤–éƒ¨ä¾è³´ï¼ˆå¦‚è³‡æ–™åº«ï¼‰ï¼Œä¾†æ¨¡æ“¬çœŸå¯¦çš„ç”¨æˆ¶å ´æ™¯ã€‚

## ğŸ”§ é…ç½® (Configuration)

æ‡‰ç”¨ç¨‹å¼çš„é…ç½®é€šéä»¥ä¸‹æ–¹å¼åŠ è¼‰ï¼Œå„ªå…ˆç´šå¾ä½åˆ°é«˜ï¼š

1.  **`config/default.toml`**: å­˜å„²æ‰€æœ‰é…ç½®é …çš„é è¨­å€¼ã€‚
2.  **ç’°å¢ƒè®Šæ•¸**:
    - å¯ä»¥é€šé `.env` æ–‡ä»¶è¨­ç½®ã€‚
    - è®Šæ•¸éœ€ä»¥ `APP_` ç‚ºå‰ç¶´ï¼Œä¸¦ä½¿ç”¨ `__` ä½œç‚ºå±¤ç´šåˆ†éš”ç¬¦ã€‚ä¾‹å¦‚ï¼Œè¦è¦†è“‹ `db.host`ï¼Œéœ€è¨­ç½®ç’°å¢ƒè®Šæ•¸ `APP_DB__HOST=...`ã€‚

æ‰€æœ‰å¯é…ç½®çš„é¸é …éƒ½åœ¨ `app/src/config.rs` ä¸­å®šç¾©ã€‚

## ğŸ“œ è²¢ç» (Contributing)

æ­¡è¿æäº¤ Pull Requestsï¼ç‚ºäº†ä¿æŒç¨‹å¼ç¢¼å“è³ªï¼Œè«‹ç¢ºä¿ï¼š

- ä½ çš„ç¨‹å¼ç¢¼é€šéäº† `cargo clippy --all-targets -- -D warnings` çš„æª¢æŸ¥ã€‚
- ä½ çš„ç¨‹å¼ç¢¼é€šéäº† `cargo fmt` çš„æ ¼å¼åŒ–ã€‚
- æ‰€æœ‰ç¾æœ‰æ¸¬è©¦éƒ½èƒ½é€šéï¼Œä¸¦ç‚ºæ–°åŠŸèƒ½æ·»åŠ äº†é©ç•¶çš„æ¸¬è©¦ã€‚

## ğŸ“„ æˆæ¬Š (License)

æœ¬å°ˆæ¡ˆæ¡ç”¨ [MIT License](LICENSE)ã€‚

```
find . -path ./target -prune -o -type f \( -name "*.rs" -o -name "*.toml" \) -print | while read file; do
  echo "=== $file ===" >> all_code.txt
  cat "$file" >> all_code.txt
  echo -e "\n" >> all_code.txt
done

```

```
docker run --name my-postgres \
  -e POSTGRES_USER=myuser \
  -e POSTGRES_PASSWORD=mypassword \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  -d postgres:16.9-bullseye

```

export DATABASE_URL="postgres://myuser:mypassword@localhost:5432/mydb"

psql postgres://myuser:mypassword@localhost:5432/mydb -c '\dt'
